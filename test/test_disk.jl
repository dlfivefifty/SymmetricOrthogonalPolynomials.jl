using MultivariateOrthogonalPolynomials, StaticArrays, Test, ClassicalOrthogonalPolynomials
using ClassicalOrthogonalPolynomials: expand

œÅ = Œ∏ -> @SMatrix([cos(Œ∏) -sin(Œ∏); sin(Œ∏) cos(Œ∏)])

function anglevec(ùê±)
    x,y = ùê±
    @SMatrix([[x,y]/sqrt(x^2+y^2) [-y,x] /sqrt(x^2+y^2)])
end

# œÅÃÑ = (ùê±, Œ∏) -> anglevec(œÅ(Œ∏)*ùê±) * inv(anglevec(ùê±))

œÅÃÑ = (ùê±, Œ∏) -> œÅ(Œ∏)

Z = Zernike()

ùïç = (n,x,y) -> hcat([[Z[SVector(x,y),Block(n+1)[k+1]], 0] for k=0:n]..., [[0,Z[SVector(x,y),Block(n+1)[k+1]]] for k=0:n]...)



Œ∏ = 0.1
ùê± = SVector(0.1,0.2); x,y = ùê±




@test  ùïç(0,œÅ(Œ∏)*[x,y]...) ‚âà œÅÃÑ([x,y], Œ∏) * ùïç(0,x,y) * œÅ(-Œ∏)


œÅÃÑ([1,0],œÄ/4) * [1,0]

n = 1; x1,y1 = 0.2,0.3; x2,y2 = -0.123,0.245;
C = [œÅÃÑ([x,y], Œ∏)*ùïç(n,x,y);
    œÅÃÑ([x1,y1], Œ∏)*ùïç(n,x1,y1);
    œÅÃÑ([x2,y2], Œ∏)*ùïç(n,x2,y2)] \ [ùïç(n,œÅ(Œ∏)*[x,y]...); ùïç(n,œÅ(Œ∏)*[x1,y1]...); ùïç(n,œÅ(Œ∏)*[x2,y2]...)]

eigvals(C) # m = 0 (2x), m = ¬±2

n = 2; x1,y1 = 0.2,0.3; x2,y2 = -0.123,0.245;
C = [œÅÃÑ([x,y], Œ∏)*ùïç(n,x,y);
    œÅÃÑ([x1,y1], Œ∏)*ùïç(n,x1,y1);
    œÅÃÑ([x2,y2], Œ∏)*ùïç(n,x2,y2)] \ [ùïç(n,œÅ(Œ∏)*[x,y]...); ùïç(n,œÅ(Œ∏)*[x1,y1]...); ùïç(n,œÅ(Œ∏)*[x2,y2]...)]

eigvals(C) # m = ¬±1 (2x), m = ¬±3



n = 3; x1,y1 = 0.2,0.3; x2,y2 = -0.123,0.245; x3,y3 = 0.421, -0.9
C = [œÅÃÑ([x,y], Œ∏)*ùïç(n,x,y);
    œÅÃÑ([x1,y1], Œ∏)*ùïç(n,x1,y1);
    œÅÃÑ([x2,y2], Œ∏)*ùïç(n,x2,y2);
    œÅÃÑ([x3,y3], Œ∏)*ùïç(n,x3,y3)] \ [ùïç(n,œÅ(Œ∏)*[x,y]...); ùïç(n,œÅ(Œ∏)*[x1,y1]...); ùïç(n,œÅ(Œ∏)*[x2,y2]...); ùïç(n,œÅ(Œ∏)*[x3,y3]...)]

eigvals(C) # m = 0 (2x), m = ¬±2 (2x), m = ¬±4

# rotationally invariant matrices
# (A * v)(œÅ*x) == œÅÃÑ * A*v
# (A(œÅ*x) * œÅÃÑ v) == œÅÃÑ * A*v
# A(œÅ*x) * œÅÃÑ == œÅÃÑ * A

Q = eigen(œÅÃÑ([x,y], Œ∏)).vectors

Q'*œÅÃÑ([x,y], Œ∏)*Q

A = Q*Diagonal(randn(2))*Q'

Œ∏=0.3; @test A*œÅÃÑ([x,y], Œ∏) ‚âà œÅÃÑ([x,y], Œ∏)*A

# r^m * exp(im*m*Œ∏) * f(r^2)
# ‚àá  =  r^(m-1)exp(im*m*Œ∏) * ((m*f(r^2) + 2r^2*f'(r^2))e_r + im * m * f(r^2) *e_Œ∏)
# ‚àá‚üÇ =  r^(m-1)exp(im*m*Œ∏) * ((m*f(r^2) + 2r^2*f'(r^2))e_r + im * m * f(r^2) *e_Œ∏)

# m= 0: r*e_r = [x,y]
# m= 1: x * [x,y], y * [-y,x]

# r^(m+1) * exp(im*m*Œ∏) * f(r^2) * e_r is degree (f + m+1)

# [x^2 x*y; y*x y^2] 
# [1 0; 0 1]

A = (x,y) -> [x^2 x*y; y*x y^2] 

@test A(œÅ(Œ∏)*[x,y]...)*œÅÃÑ([x,y], Œ∏) ‚âà œÅÃÑ([x,y], Œ∏)*A(x,y)


sum(expand(Zernike(), ùê± -> 1))

V = [ (x,y) -> [1,0], (x,y) -> [0,1], # m = 1

    # d = 1, n = 3
      (x,y) -> [x,y], # m = 0
      (x,y) -> [-y,x], # m = 0
      (x,y) -> [x,-y], (x,y) -> [y,x], # m = 2
    # d = 2, n = 7

      (x,y) -> legendrep(1,2*(x^2+y^2)-1)*V[1](x,y), (x,y) -> legendrep(1,2*(x^2+y^2)-1)*V[2](x,y), # m = 1
      (x,y) -> [(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[1](x,y), (x,y) -> [(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[2](x,y), # m=1
      (x,y) -> (r = sqrt(x^2+y^2); Œ∏ = atan(y,x); m=3; m*r^(m-2)*(cos(m*Œ∏)*[x,y] - sin(m*Œ∏)*[-y,x])),
      (x,y) -> (r = sqrt(x^2+y^2); Œ∏ = atan(y,x); m=3; m*r^(m-2)*(sin(m*Œ∏)*[x,y] + cos(m*Œ∏)*[-y,x])), # m = 3

    # d = 3, n = 13
      (x,y) -> jacobip(1,0,1,2*(x^2+y^2)-1)*V[3](x,y), # m = 0
      (x,y) -> jacobip(1,0,1,2*(x^2+y^2)-1)*V[4](x,y), # m = 0
      (x,y) -> jacobip(1,0,1,2*(x^2+y^2)-1)*V[5](x,y), (x,y) -> jacobip(1,0,1,2*(x^2+y^2)-1)*V[6](x,y), # m = 2
      (x,y) -> [(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[5](x,y), (x,y) -> [(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[6](x,y), # m = 2
      (x,y) -> (r = sqrt(x^2+y^2); Œ∏ = atan(y,x); m=4; m*r^(m-2)*(cos(m*Œ∏)*[x,y] - sin(m*Œ∏)*[-y,x])),
      (x,y) -> (r = sqrt(x^2+y^2); Œ∏ = atan(y,x); m=4; m*r^(m-2)*(sin(m*Œ∏)*[x,y] + cos(m*Œ∏)*[-y,x])), # m = 4  

    # d = 4, n = 21      
        (x,y) -> legendrep(2,2*(x^2+y^2)-1)*V[1](x,y), (x,y) -> legendrep(2,2*(x^2+y^2)-1)*V[2](x,y), # m = 1
        (x,y) -> jacobip(1, 0, 2, 2*(x^2+y^2)-1)*[(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[1](x,y), (x,y) -> jacobip(1, 0, 2, 2*(x^2+y^2)-1)*[(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[2](x,y), # m=1
        (x,y) -> jacobip(1, 0, 2, 2*(x^2+y^2)-1)*V[11](x,y), (x,y) -> jacobip(1, 0, 2, 2*(x^2+y^2)-1)*V[12](x,y), # m = 3
        (x,y) -> [(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[11](x,y), (x,y) -> [(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*V[12](x,y), # m = 3
        (x,y) -> (r = sqrt(x^2+y^2); Œ∏ = atan(y,x); m=5; m*r^(m-2)*(cos(m*Œ∏)*[x,y] - sin(m*Œ∏)*[-y,x])),
      (x,y) -> (r = sqrt(x^2+y^2); Œ∏ = atan(y,x); m=5; m*r^(m-2)*(sin(m*Œ∏)*[x,y] + cos(m*Œ∏)*[-y,x])), # m = 5
      ]


ùê± = SVector(0.1,0.2); x,y = ùê±
@test [V[1]((œÅ(Œ∏) * ùê±)...) V[2]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[1](x,y) V[2](x,y)] * œÅ(-Œ∏)

@test V[3]((œÅ(Œ∏) * ùê±)...) ‚âà œÅÃÑ(ùê±,Œ∏) * V[3](x,y)
@test V[4]((œÅ(Œ∏) * ùê±)...) ‚âà œÅÃÑ(ùê±,Œ∏) * V[4](x,y)
@test [V[5]((œÅ(Œ∏) * ùê±)...) V[6]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[5](x,y) V[6](x,y)] *  œÅ(-Œ∏)^2

@test [V[7]((œÅ(Œ∏) * ùê±)...) V[8]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[7](x,y) V[8](x,y)] *  œÅ(-Œ∏)
@test [V[9]((œÅ(Œ∏) * ùê±)...) V[10]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[9](x,y) V[10](x,y)] *  œÅ(-Œ∏)
@test [V[11]((œÅ(Œ∏) * ùê±)...) V[12]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[11](x,y) V[12](x,y)] *  œÅ(-Œ∏)^3

@test V[13]((œÅ(Œ∏) * ùê±)...) ‚âà œÅÃÑ(ùê±,Œ∏) * V[13](x,y)
@test V[14]((œÅ(Œ∏) * ùê±)...) ‚âà œÅÃÑ(ùê±,Œ∏) * V[14](x,y)
@test [V[15]((œÅ(Œ∏) * ùê±)...) V[16]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[15](x,y) V[16](x,y)] *  œÅ(-Œ∏)^2 
@test [V[17]((œÅ(Œ∏) * ùê±)...) V[18]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[17](x,y) V[18](x,y)] *  œÅ(-Œ∏)^2 
@test [V[19]((œÅ(Œ∏) * ùê±)...) V[20]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[19](x,y) V[20](x,y)] *  œÅ(-Œ∏)^4

# d = 3
@test [V[21]((œÅ(Œ∏) * ùê±)...) V[22]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[21](x,y) V[22](x,y)] *  œÅ(-Œ∏)
@test [V[23]((œÅ(Œ∏) * ùê±)...) V[24]((œÅ(Œ∏) * ùê±)...)] ‚âà œÅÃÑ(ùê±,Œ∏) * [V[23](x,y) V[24](x,y)] *  œÅ(-Œ∏)


# d = 2
n = 10; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 11; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 12; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))

# d = 3
n = 13; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 14; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 15; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 16; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 17; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 18; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 19; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 20; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))

# d = 4
n = 21; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 22; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 23; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 24; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 25; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 26; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 27; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 28; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 29; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 30; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))




w = (x,y) -> jacobip(1, 0, 2, 2*(x^2+y^2)-1)*[(x^2-y^2) 2x*y; 2x*y (y^2-x^2)]*[1,0]

sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(w(x,y), [1+x+y+x^2+x*y+y^2+x^3+x^2*y+x*y^2+y^3,1+x+y+x^2+x*y+y^2+x^3+x^2*y+x*y^2+y^3]))))

###
# OLD
###


M = (x,y) -> [chebyshevu(2,x)/4 x*y; x*y chebyshevu(2,y)/4]
@test M((œÅ(Œ∏)*[x,y])...) * œÅÃÑ([x,y],Œ∏) ‚âà œÅÃÑ([x,y],Œ∏) * M(x,y)

sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[1](x,y), M(x,y)*V[1](x,y)))))


P = Zernike()
ùê± = 

sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[9](x,y), V[7](x,y)))))


x,y = 0.1,0.2



r = sqrt(x^2+y^2)
Œ∏ = atan(y,x)
@test [chebyshevu(2,x)/4 x*y; x*y chebyshevu(2,y)/4] ‚âà œÅÃÑ([r,0],Œ∏)*[chebyshevu(2,r)/4 0; 0 chebyshevu(2,0)/4]*œÅÃÑ([x,y],-Œ∏)

sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; [0,1]'*[chebyshevu(2,x)/4 x*y; x*y chebyshevu(2,y)/4]*[0,1])))

A = ùê± ->  ((x,y) = ùê±; [chebyshevu(2,x)/4 x*y; x*y chebyshevu(2,y)/4])
sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; r = norm(ùê±); Œ∏ = atan(y,x); [0,1]'*A(œÅ(Œ∏)*[r,0])*[0,1])))
sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; r = norm(ùê±); Œ∏ = atan(y,x); [0,1]'*œÅÃÑ([r,0],Œ∏)*A([r,0])*œÅÃÑ([x,y],-Œ∏)*[0,1])))
sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; r = norm(ùê±); Œ∏ = atan(y,x); [0,1]'*œÅÃÑ([r,0],Œ∏)*A([r,0])*œÅ(-Œ∏)*[0,1])))
sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; r = norm(ùê±); Œ∏ = atan(y,x); [0,1]'*œÅ(Œ∏)*A([r,0])*œÅ(-Œ∏)*[0,1])))



sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot([y^3,0],legendrep(2,2*(x^2+y^2)-1)*[1,0]))))


sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot([chebyshevu(2,x)/4,x*y],legendrep(1,2*(x^2+y^2)-1)*[1,0]))))

sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot([chebyshevu(2,x)/4,x*y],legendrep(1,2*(x^2+y^2)-1)*[0,1]))))

@test sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(legendrep(1,2*(x^2+y^2)-1)*[1,0],legendrep(1,2*(x^2+y^2)-1)*[1,0])))) ‚âà œÄ/3
sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot([chebyshevu(2,x)/4  - 1/4*legendrep(1,2*(x^2+y^2)-1),x*y],legendrep(1,2*(x^2+y^2)-1)*[1,0]))))

A = (x,y) ->  [-2x*y   x^2-y^2;
               x^2-y^2 2x*y]

ùê± = SVector(0.1,0.2)
@test A((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)A(ùê±...)



###
# matrix basis
###


A = (x,y) -> I(2)
@test A((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)A(ùê±...)
A = (x,y) -> [0 1; -1 0]
@test A((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)A(ùê±...)
A = (x,y) -> [1 0; 0 -1]
B = (x,y) -> [0 1; 1 0]
@test [œÅÃÑ(ùê±,-Œ∏)A((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),œÅÃÑ(ùê±,-Œ∏)B((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)^2 * [A(ùê±...),B(ùê±...)]



using StaticArrays
B = (x,y) -> [@SMatrix([1 0; 0 0]), @SMatrix([0 1; 0 0]), @SMatrix([0 0; 1 0]), @SMatrix([0 0 ; 0 1])]


B(ùê±...)

ùê±

using BlockArrays

Œ∏
@test [(ùê± = SVector(0.1,0.2); (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏))))  (ùê± = SVector(0.1,-0.3); (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏))))] ‚âà
    [0.2 -0.4 -0.4 0.8;
 0.4 0.2 -0.8 -0.4;
 0.4 -0.8 0.2 -0.4;
 0.8 0.4 0.4 0.2] * [(ùê± = SVector(0.1,0.2); B(ùê±...)) (ùê± = SVector(0.1,-0.3); B(ùê±...))]

 R_Œ∏ = [0.2 -0.4 -0.4 0.8;
        0.4 0.2 -0.8 -0.4;
        0.4 -0.8 0.2 -0.4;
        0.8 0.4 0.4 0.2]

R_Œ∏'R_Œ∏

eigen(Q)




B = (x,y) -> [[(A = zero(SMatrix{2,2,Float64}); setindex(A, x, k)) for k=1:4]; [(A = zero(SMatrix{2,2,Float64}); setindex(A, y, k)) for k=1:4]]

xs = [SVector(0.1,0.2), SVector(-0.3,0.1), SVector(0.3,-0.7), SVector(-0.1,-0.1)]
M = [getindex.((ùê± = xs[1]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),1) getindex.((ùê± = xs[2]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),1) getindex.((ùê± = xs[3]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),1) getindex.((ùê± = xs[4]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),1)]'
X11 = [first.(xs) last.(xs)] \ M
M = [getindex.((ùê± = xs[1]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),2) getindex.((ùê± = xs[2]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),2) getindex.((ùê± = xs[3]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),2) getindex.((ùê± = xs[4]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),2)]'
X21 = [first.(xs) last.(xs)] \ M
M = [getindex.((ùê± = xs[1]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),3) getindex.((ùê± = xs[2]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),3) getindex.((ùê± = xs[3]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),3) getindex.((ùê± = xs[4]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),3)]'
X12 = [first.(xs) last.(xs)] \ M
M = [getindex.((ùê± = xs[1]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),4) getindex.((ùê± = xs[2]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),4) getindex.((ùê± = xs[3]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),4) getindex.((ùê± = xs[4]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),4)]'
X22 = [first.(xs) last.(xs)] \ M

Q = [X11[1,:]'; X21[1,:]'; X12[1,:]'; X22[1,:]';
        X11[2,:]'; X21[2,:]'; X12[2,:]'; X22[2,:]';]


@test (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏))) ‚âà Q'*B(ùê±...)



getindex.((ùê± = xs[1]; (Ref(œÅÃÑ(ùê±, -Œ∏)) .* B((œÅ(Œ∏)*ùê±)...) .* Ref(œÅÃÑ(ùê±, Œ∏)))),1)



V = [# d = 0
    (x,y) -> [1 0; 0 1], # m = 0
     (x,y) -> [0 -1; 1 0], # m = 0
     (x,y) -> [1 0; 0 -1], (x,y) -> [0 1; 1 0], # m = 2

     # d = 1, n = 5
     (x,y) -> [x y; y -x], (x,y) -> [-y x; x y], # m = 1
     (x,y) -> [x -y; y x], (x,y) -> [y x; -x y], # m = 1
     (x,y) -> [x y; -y x], (x,y) -> [y -x; x y], # m = 1
     (x,y) -> [x -y; -y -x], (x,y) -> [y x; x -y], # m = 3

    # d = 2, n = 13
    (x,y) -> legendrep(1,2*(x^2+y^2)-1)*V[1](x,y), # m = 0
    (x,y) -> [x^2-y^2 2x*y; 2x*y y^2-x^2], # m = 0    A(x,y)*V[1](x,y)
    (x,y) -> legendrep(1,2*(x^2+y^2)-1)*V[2](x,y), # m = 0
    (x,y) -> [2x*y y^2-x^2; y^2-x^2 -2x*y], # m = 0 .  A(x,y)*V[2](x,y)
    (x,y) -> legendrep(1,2*(x^2+y^2)-1)*V[3](x,y), (x,y) -> legendrep(1,2*(x^2+y^2)-1)*V[4](x,y), # m = 2
    (x,y) -> [x^2-y^2 -2x*y; 2x*y x^2-y^2], (x,y) -> [2x*y x^2-y^2; y^2-x^2 2x*y], # m = 2
     (x,y) ->[2x*y x^2-y^2; x^2-y^2 -2x*y],
    (x,y) ->[2x*y y^2-x^2; x^2-y^2 2x*y],
    (x,y) -> [x^2-y^2 -2x*y; -2x*y x^2-y^2],
    # (x,y) -> V[16](x,y)*V[3](x,y), (x,y) -> V[16](x,y)*V[4](x,y), # m = 2
 ]

# d = 0
@test V[1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)V[1](ùê±...)
@test V[2]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)V[2](ùê±...)
@test [V[3]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[4]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)^2*[œÅÃÑ(ùê±,Œ∏)V[3](ùê±...),œÅÃÑ(ùê±,Œ∏)V[4](ùê±...)]

#d = 1
n = 5; @test [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]
n = 7; @test [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]
n = 9; @test [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]
n = 11; @test [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)^3*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]

# d = 2
n = 13; @test V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)V[n](ùê±...)
n = 14; @test V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)V[n](ùê±...)
n = 15; @test V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)V[n](ùê±...)
n = 16; @test V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏) ‚âà œÅÃÑ(ùê±,Œ∏)V[n](ùê±...)
n = 17; @test [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)^2*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]
n = 19; @test [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)^2*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]
n = 21; @test_broken [V[n]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏),V[n+1]((œÅ(Œ∏)ùê±)...)œÅÃÑ(ùê±,Œ∏)] ‚âà œÅ(Œ∏)^4*[œÅÃÑ(ùê±,Œ∏)V[n](ùê±...),œÅÃÑ(ùê±,Œ∏)V[n+1](ùê±...)]

# d = 0
n = 2; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 3; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 4; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))

# d = 1
n = 5; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 6; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 7; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 8; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 9; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 10; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 11; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 12; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))

# d= 2
n = 13; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 14; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 15; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 16; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 17; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 18; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 19; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 20; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 21; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 22; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))
n = 23; sum(expand(Zernike(), ùê± -> ((x,y) = ùê±; dot(V[n](x,y), sum(V[k](x,y) for k=1:n-1)))))


X = randn(3, 100); for j = 1:size(X,2) X[:,j] = X[:,j]/norm(X[:,j]) end


K = zeros(100, 9+15+3)
for k = 1:size(K,1)
  x,y,z = X[:,k]
  K[k,:] = [x,y,z]'*[1 0 0 x y z 0 0 0 0 0 0 x^2 y^2 x*y x*z y*z 0 0 0 0 0 0 0 0 0 0
                     0 1 0 0 0 0 x y z 0 0 0 0 0 0 0 0 x^2 y^2 x*y x*z y*z 0 0 0 0 0
                      0 0 1 0 0 0 0 0 0 x y z 0 0 0 0 0 0 0 0 0 0 x^2 y^2 x*y x*z y*z]
end

nullspace(K)